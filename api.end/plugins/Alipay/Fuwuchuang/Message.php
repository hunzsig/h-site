<?php
 namespace Alipay\Lib\Fuwuchuang; use Alipay\Lib\Fuwuchuang\AbstractLib; use Alipay\Lib\Fuwuchuang\PushMsg; class Message extends AbstractLib{ public function Message($biz_content) { if($biz_content){ header ( "Content-Type: text/xml;charset=GBK" ); $UserInfo = $this->getNode ( $biz_content, "UserInfo" ); $FromUserId = $this->getNode ( $biz_content, "FromUserId" ); $AppId = $this->getNode ( $biz_content, "AppId" ); $CreateTime = $this->getNode ( $biz_content, "CreateTime" ); $MsgType = $this->getNode ( $biz_content, "MsgType" ); $EventType = $this->getNode ( $biz_content, "EventType" ); $AgreementId = $this->getNode ( $biz_content, "AgreementId" ); $ActionParam = $this->getNode ( $biz_content, "ActionParam" ); $AccountNo = $this->getNode ( $biz_content, "AccountNo" ); $push = new PushMsg(); if ($MsgType == "text") { $text = $this->getNode ( $biz_content, "Text" ); $text_msg = $push->mkTextMsg ( "你好，这是对话消息" ); $biz_content = $push->mkTextBizContent ( $FromUserId, $text_msg ); $biz_content = iconv ( "UTF-8", "GBK//IGNORE", $biz_content ); $return_msg = $push->sendRequest ( $biz_content ); } if ($MsgType == "image") { $mediaId = $this->getNode ( $biz_content, "MediaId" ); $format = $this->getNode ( $biz_content, "Format" ); $biz_content = "{\"mediaId\":\"" . $mediaId . "\"}"; $fileName = realpath ( "img" ) . "/$mediaId.$format"; $push->downMediaRequest ( $biz_content, $fileName ); $text_msg = $push->mkTextMsg ( "你好，图片已接收。" ); $biz_content = $push->mkTextBizContent ( $FromUserId, $text_msg ); $biz_content = iconv ( "UTF-8", "GBK//IGNORE", $biz_content ); $return_msg = $push->sendRequest ( $biz_content ); } if ($EventType == "follow") { $image_text_msg1 = $push->mkImageTextMsg ( "标题，感谢关注", "描述", "http://wap.taobao.com", "https://i.alipayobjects.com/e/201310/1H9ctsy9oN_src.jpg", "loginAuth" ); $image_text_msg2 = $push->mkImageTextMsg ( "标题", "描述", "http://wap.taobao.com", "https://i.alipayobjects.com/e/201310/1H9ctsy9oN_src.jpg", "loginAuth" ); $image_text_msg = array ( $image_text_msg1, $image_text_msg2 ); $biz_content = $push->mkImageTextBizContent ( $FromUserId, $image_text_msg ); $return_msg = $push->sendRequest ( $biz_content ); file_put_contents ( "log.txt", $return_msg . "\r\n", FILE_APPEND ); } elseif ($EventType == "unfollow") { } elseif ($EventType == "enter") { $arr = json_decode ( $ActionParam ); if ($arr != null) { $sceneId = $arr->scene->sceneId; } $image_text_msg1 = $push->mkImageTextMsg ( "标题，进入服务窗", "描述：进入服务窗", "http://wap.taobao.com", "", "loginAuth" ); $image_text_msg = array ( $image_text_msg1 ); $biz_content = $push->mkImageTextBizContent ( $FromUserId, $image_text_msg ); $return_msg = $push->sendRequest ( $biz_content ); } elseif ($EventType == "click") { if ($ActionParam == "sendmsg") { $image_text_msg1 = $push->mkImageTextMsg ( "标题，发送消息测试", "描述：发送消息测试", "http://wap.taobao.com", "", "loginAuth" ); $image_text_msg = array ( $image_text_msg1 ); $biz_content = $push->mkImageTextBizContent ( $FromUserId, $image_text_msg ); $return_msg = $push->sendRequest ( $biz_content ); } } echo self::mkAckMsg ( $FromUserId ); exit (); } } public function mkAckMsg($toUserId) { $as = new AlipaySign(); $config = $this->getConfig(); $response_xml = "<XML><ToUserId><![CDATA[" . $toUserId . "]]></ToUserId><AppId><![CDATA[" . $config['app_id'] . "]]></AppId><CreateTime>" . time () . "</CreateTime><MsgType><![CDATA[ack]]></MsgType></XML>"; $return_xml = $as->sign_response ( $response_xml, $config ['charset'], $config ['merchant_private_key_file'] ); return $return_xml; } public function getNode($xml, $node) { $xml = "<?xml version=\"1.0\" encoding=\"GBK\"?>" . $xml; $dom = new \DOMDocument("1.0","GBK"); $dom->loadXML ( $xml ); $event_type = $dom->getElementsByTagName ( $node ); return $event_type->item ( 0 )->nodeValue; } }